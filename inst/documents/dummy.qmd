---
params:
  script: 'dev'
  with_library_paths: library_paths
  check_approved_folder_pkgs: NULL
  check_approved_url_pkgs: NULL
  renv: TRUE
  tmpdir: "."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  error = TRUE,
  warning = TRUE,
  message = TRUE,
  echo = TRUE
)

.libPaths(c(character(), params$with_library_paths))
```

```{r, echo=FALSE, eval=(grepl("\\.R$", params$script))}
knitr::spin_child(params$script)
```

```{r, child = params$script, eval=(grepl("\\.qmd$", params$script))}
```

```{r, child = params$script, eval=(grepl("\\.Rmd$", params$script))}
```

```{python, file=params$script, eval=(grepl("\\.py$", params$script))}
```

```{python, eval=(grepl("\\.py$", params$script)), echo=FALSE}
import json
import sys
import subprocess

temp_dir = r.params['tmpdir']

# Get a list of installed packages using pip list
installed_packages = subprocess.check_output([sys.executable, '-m', 'pip', 'list', '-v']).decode('utf-8').strip().split('\n')[2:]
installed_packages = {package.split()[0]: [package.split()[1], package.split()[2]] for package in installed_packages}

imported_modules = {}
for module_name, module in sys.modules.items():
    if not (module_name.startswith('_') or module_name.startswith('.') or '.' in module_name):
        if module_name in installed_packages:
            imported_modules[module_name] = {
                "version": installed_packages[module_name][0],
                "installation_path": installed_packages[module_name][1]
            }

with open(f'{temp_dir}/python_imports.json', 'w') as json_file:
    json.dump(imported_modules, json_file)

```


```{r sessioninfo, include=FALSE}
saveRDS(
  object = whirl:::session_info(params$check_approved_folder_pkgs, params$check_approved_url_pkgs),
  file = file.path(params$tmpdir, "session_info.rds")
)

if (is.character(params$renv) && params$renv == "yes" | is.logical(params$renv) && params$renv) {
  saveRDS(
    object = whirl:::renv_status(),
    file = file.path(params$tmpdir, "renv_status.rds")
  )
}

```

